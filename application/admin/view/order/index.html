{include file="public/header" /}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto">
            <div class="layui-btn-group" style="margin-bottom: 30px;">
                <button type="button" class="layui-btn list-shop" data-type='0'>全部</button> 
                {volist name='shop_list' id='val'}
                <button type="button" class="layui-btn layui-btn-primary list-shop" data-type='{$val.id}'>{$val.name}</button> 
                {/volist} 

            </div>
            <button style='float: right;margin-right: 20px;' class="layui-btn layuiadmin-btn-admin" type="button" data-type="importOrder"><i class="layui-icon"></i>导入订单</button>
            <div class="layui-form-item">
                <!--                <div class="layui-inline">
                                    <button class="layui-btn layuiadmin-btn-admin" data-type="add" >添加订单</button>
                                </div>-->
                <div class="layui-inline">
                    <label class="layui-form-label">来客订单号</label>
                    <div class="layui-input-block">
                        <input type="text" name="order_num"  placeholder="请输入订单编号搜索" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">商品名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="item_name" placeholder="请输入商品名称搜索" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">来客订单状态</label>
                    <div class="layui-input-block">
                        <input type="text" name="item_name" placeholder="请输入商品名称搜索" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">订单跟进状态</label>
                    <div class="layui-input-block">
                        <input type="text" name="item_name" placeholder="请输入商品名称搜索" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">联系人姓名</label>
                    <div class="layui-input-block">
                        <input type="text" name="buy_phone" placeholder="请输入手机号搜索" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">联系手机号</label>
                    <div class="layui-input-block">
                        <input type="text" name="buy_phone" placeholder="请输入手机号搜索" autocomplete="off" class="layui-input">
                    </div>
                </div> 
                <div class="layui-inline">
                    <label class="layui-form-label">销售人员</label>
                    <div class="layui-input-block">
                        <select name="kefu_id" lay-search=""> 
                            <option value="">请选择客服</option> 
                            {foreach name="kefu_list" item="vo"}
                            <option value="{$vo.id}" {if condition="$vo.status eq 2" } disabled="" {/if}>{$vo.admin_name}</option>
                            {/foreach}
                        </select>
                    </div>
                </div> 
                <div class="layui-inline">
                    <label class="layui-form-label">订单标签</label>
                    <div class="layui-input-block">
                        <select name="kefu_id" lay-search=""> 
                            <option value="">请选择客服</option> 
                            {foreach name="kefu_list" item="vo"}
                            <option value="{$vo.id}" {if condition="$vo.status eq 2" } disabled="" {/if}>{$vo.admin_name}</option>
                            {/foreach}
                        </select>
                    </div>
                </div> 
                <div class="layui-inline">                          
                    <label class="layui-form-label">所属客服</label>
                    <div class="layui-input-inline">
                        <select name="kefu_id" lay-search=""> 
                            <option value="">请选择客服</option> 
                            {foreach name="kefu_list" item="vo"}
                            <option value="{$vo.id}" {if condition="$vo.status eq 2" } disabled="" {/if}>{$vo.admin_name}</option>
                            {/foreach}
                        </select>
                    </div>     
                </div>   
                <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-admin" lay-submit lay-filter="LAY-user-back-search">
                        搜索
                    </button>
                </div>
            </div>
        </div>
        <div class="layui-tab layui-tab-brief">
            <!--            <ul class="layui-tab-title">
                            <li data-type='0' class="layui-this list-status">未预约</li>
                            <li data-type='1' class="list-status" >待接单</li>
                            <li data-type='2' class="list-status" >已预约</li>
                            <li data-type='3' class="list-status" >已完成</li>
                            <li data-type='4' class="list-status" >取消/退款申请</li>
                            <li data-type='5' class="list-status" >已取消</li>
                        </ul>-->
            <div class="layui-tab-content">        
                <div class="layui-tab-item layui-show"> 
                    <table id="LAY-user-back-manage" lay-filter="LAY-user-back-manage"></table>
                    <script type="text/html" id="batch-table-toolbar">
                        <div class="layui-btn-container">
                            <button class="layui-btn layui-btn-sm" lay-event="batch_assign">批量分配客服</button>
                        </div>
                        </script>
                        <script type="text/html" id="table-useradmin-admin">
                            <!--<a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>-->
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="info"><i class="layui-icon layui-icon-about"></i>详情</a>
                            <!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>-->
                            </script>                           
                        </div>   
                    </div>

                </div>
                <div class="layui-form" style="margin-top: 20px; display: none;" id="editModal">
                    <div class="layui-form-item">
                        <label class="layui-form-label">所属客服</label>
                        <div class="layui-input-inline">
                            <select name="kefu_id" lay-search="" id='kefu_id' lay-verify="required"> 
                                <option value="">请选择客服</option> 
                                {foreach name="kefu_list" item="vo"}
                                <option value="{$vo.id}" {if condition="$vo.status eq 2" } disabled="" {/if}>{$vo.admin_name}</option>
                                {/foreach}
                            </select>
                        </div> 
                    </div>
                    <div class="layui-form-item layui-hide">
                        <button class="layui-btn layui-btn-normal" id='submitForm' lay-filter="submitForm" lay-submit>确认提交</button>
                    </div>
                </div>

            </div>
        </div>
        <link rel="stylesheet" href="__LAYUI__/formSelects-v4.css" >
        <script src="__LAYUI__/formSelects-v4.js"></script>
        {include file="public/footer" /}

        <script>
            var listUrl = 'index';          //当前列表 URL
            var addEditUrl = 'edit';    //新增、编辑
            var delUrl = 'del';         //删除
            var stateUrl = 'state';     //状态
            var shop_id = 0;

            //动态表格
            layui.use(['table', 'upload', 'form'], function () {
                var $ = layui.$;
                var table = layui.table;
                var area = ['40%', '80%'];
                var form = layui.form;
                //执行渲染 - 实例 Table
                function render() {
                    table.render({
                        elem: '#LAY-user-back-manage',
                        url: listUrl + '?shop_id=' + shop_id,
                        page: true,
                        toolbar: '#batch-table-toolbar',
                        defaultToolbar: ['filter', 'exports'], //exports
                        title: '订单导出',
                        totalRow: true,
                        limit: 20,
                        cols: [[
                                {type: 'checkbox'},
                                {field: 'id', title: '订单ID', totalRowText: '合计', width: 80},
                                {field: 'shop_id', title: '所属店铺', templet: function (d) {
                                        return d.shop.name;
                                    }, width: 120},
                                {field: 'kefu_id', title: '所属客服', templet: function (d) {
                                        return d.kefu ? d.kefu.admin_name : '';
                                    }, width: 100},
                                {field: 'order_num', title: '来客订单号', width: 120},
                                {field: 'laike_order_status', title: '来客订单状态'},
                                {field: 'order_status_text', title: '订单跟进状态'},
                                {field: 'item_name', title: '商品名称', width: 250},
                                {field: 'buy_name', title: '姓名', width: 80, edit: 'text'},
                                {field: 'buy_phone', title: '购买人手机号', width: 120, edit: 'text'},
                                {field: 'sales_name', title: '销售人员', width: 100},
//                                {field: 'item_cate', title: '商品品类'},
//                                {field: 'item_type', title: '商品类型', width: 120},
//                                {field: 'buy_num', title: '购买数量', width: 100, sort: true, totalRow: true, totalRowType: 'int'},
                                {field: 'receive_amount', title: '订单实收', width: 120, templet: function (d) {
                                        return '￥' + d.receive_amount;
                                    }, sort: true, totalRow: true},
                                {field: 'pay_time', title: '支付时间', width: 150},
                                {field: 'tags', title: '订单标签', width: 120},
                                {title: '操作', toolbar: "#table-useradmin-admin", align: "center"},
                            ]]
                    });
                }
                var listUrlNew = listUrl + '?shop_id=0';
                render(listUrlNew);
                $('.list-shop').click(function () {
                    $('.list-shop').addClass('layui-btn-primary');
                    $(this).removeClass('layui-btn-primary');
                    shop_id = $(this).attr('data-type');
                    render();
                });
                //监听单元格编辑
                table.on('edit(LAY-user-back-manage)', function (obj) {
                    var value = obj.value; //得到修改后的值
                    var id = obj.data.id;
                    layui.$.post('updataValue', {id: id, field: obj.field, value: value}, function (data) {
                        if (data.code == 1000) {
                            layer.msg(data.msg, {icon: 1, time: 1500, shade: 0.1, });
                        } else {
                            layer.msg(data.msg, {icon: 2, time: 1500, shade: 0.1, });
                        }
                    });
                });
                //头工具栏事件
                table.on('toolbar(LAY-user-back-manage)', function (obj) {
                    var checkStatus = table.checkStatus(obj.config.id);
                    if (checkStatus.data.length === 0) {
                        return layer.msg('请选择数据');
                    }
                    var ids = '';
                    for (var i = 0; i < checkStatus.data.length; i++) {
                        ids += checkStatus.data[i].id + ',';
                    }
                    switch (obj.event) {
                        case 'batch_assign':
                            layui.$('#kefu_id').val('');
                            form.render('select');
                            layer.open({
                                type: 1, // 页面层类型
                                title: '批量分配客服', // 标题文字
                                area: ['20%', '30%'],
                                btn: ['确认分配'],
                                btnAlign: 'c',
                                content: $('#editModal'), // 内容元素ID或DOM对象                                
                                yes: function (index, layero) { // 弹出层成功后的回调函数，可以用来设置弹出层的样式等
                                    var kefu_id = layui.$('#kefu_id').val();
                                    if (kefu_id == '') {
                                        layer.msg('请选择分配客服', {icon: 2});
                                        return false;
                                    }
                                    layui.$.post('batchUpdate', {ids: ids, field: 'kefu_id', value: kefu_id}, function (res) {
                                        if (res.code == 1000) {
                                            layer.msg(res.msg, {offset: '15px', icon: 1, time: 1500}, function () {
                                                layui.table.reload("LAY-user-back-manage");
                                                layer.close(index);
                                            });
                                        } else {
                                            layer.msg(res.msg, {offset: '15px', icon: 2, time: 1000});
                                            return false;
                                        }
                                    });

                                }
                            });

//                            var data = checkStatus.data;
//                            layer.alert(JSON.stringify(data));
                            break;
                        case 'getCheckLength':
                            var data = checkStatus.data;
                            layer.msg('选中了：' + data.length + ' 个');
                            break;
                        case 'isAll':
                            layer.msg(checkStatus.isAll ? '全选' : '未全选');
                            break;
                    }
                    ;
                });
                //监听动态表格中的事件
                table.on("tool(LAY-user-back-manage)", function (e) {
                    //e.data;   当前行数据
                    var id = e.data.id;
                    switch (e.event) {
                        case 'edit':
                            //编辑
                            var url = addEditUrl + "?id=" + id;
                            tpmsg.addEdit(url, area, "订单编辑");
                            break;
                        case 'info':
                            //详情
                            var url = "info?id=" + id;
                            tpmsg.DataInfo(url, ['80%', '90%'], "<span class='layui-font-18'>订单详情</span>&nbsp;&nbsp;<span class='layui-font-gray'>系统编号：A251215190001；所属店铺：店铺1；来客订单号：1089391769758428895</span>");
                            break;
                        case 'del':
                            //删除
                            tpmsg.confirm(id, delUrl);
                            break;
                    }
                });
                //监听表格上列的添加、搜索框事件
                $('.layui-btn.layuiadmin-btn-admin').on('click', function () {
                    var type = $(this).data('type');
                    switch (type) {
                        case 'importOrder':
                            layer.open({
                                type: 2,
                                title: '导入订单',
                                area: ['30%', '50%'],
                                btnAlign: 'c',
                                maxmin: true,
                                content: 'importOrder',
                                yes: function (e, t) {
                                    layer.close(e);
                                }, end: function () {
                                    //                                location.reload();
                                }
                            });
                            break;
                        case 'add':
                            tpmsg.addEdit(addEditUrl, area, "添加订单");
                            break;
                    }
                });
            });
        </script>